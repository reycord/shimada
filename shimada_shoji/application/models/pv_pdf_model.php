<?php

/*
P.O. :
FROM : SHIMADA SHOJI CO.,LTD
115-16,MOTOHAMA-CHO,KOJIMA
TO : VIETNAM KURASHIKI,OKAYAMA,JAPAN
KANEDA TEL.086-474-3351 FAX.086-474-3353
------------------------------------------------------------------------------------------------
8028046 CONTRACT : VT5808 PRICE TERMS : US\
TRANSPORTATION : FOB ORDERER : (80208)MURAYAMA.H ASSISTANT : TAKENAKA.H
DESTINATION : HOCHIMINH REQUESED DELIVERY :
------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------
| SUPPLIER 7595 SHIMADA SHOJI(VIETNAM) | CASE MARK |
|---------------------------------------------------------------| |
| CONSIGNEE VNIT | |
| | |
| NIPPON EXPRESS(VIETNAM)CO.,LTD | |
| SONG THAN LOGISTICS CENTER | |
| LOT F, ROAD NO.6, SONG THAN INDUSTRIAL | |
| ZONE II, DI AN DISTRICT, BINH DUONG | |
| PROVINCE, VIETNAM | |
| TEL:84(274)379 4567/FAX:84(274)379 4568 | |
|---------------------------------------------------------------| |
| NOTE | |
| | |
| | |
| | |
| | |
------------------------------------------------------------------------------------------------
(DETAILS)
------------------------------------------------------------------------------------------------
| COLOR SIZE QUANTITY | UNIT PRICE | AMOUNT |
|-------------------------------------------------------------|-------------|------------------|
| 1)19L-PINTDPV | | |
| (L-PINTDPV)PLASTIC PIN. | | |
| | | |
| 700,000.00 PCS |\ 0.0038|\ 2,660.00 |
|-------------------------------------------------------------|-------------|------------------|
| 2)1937380TDPV | | |
| (37380TDPV)PLASTIC COLLAR KEEPER. | | |
| SIZE : 0.4MM / 37MM X 380MM | | |
| | | |
| 10,000.00 PCS |\ 0.0457|\ 457.00 |
|-------------------------------------------------------------|-------------|------------------|
| 3)1937500TDPV | | |
| (37500TDPV)PLASTIC COLLAR KEEPER. | | |
| SIZE: 0.4MM / 37MM X 500MM | | |
| | | |
| 50,000.00 PCS |\ 0.0527|\ 2,635.00 |
|-------------------------------------------------------------|-------------|------------------|
| 4)19CKP14V | | |
| (CKP14V)PLASTIC BUTTERFLY KEEPER. | | |
| | | |
| 100,000.00 PCS |\ 0.0123|\ 1,230.00 |
|----------------------------------------------------------------------------------------------|
| TOTAL AMOUNT |\ 6,982.00 |
------------------------------------------------------------------------------------------------
================================================================================================
G.TOTAL
860,000 PCS
================================================================================================
>
>
P. 2
P.O. :
ACCEPTED BY (SELLER) SHIMADA SHOJI CO.,LTD
--------------------------------- ---------------------------------
PLEASE SIGN AND RETURN ONE COPY

*/

/*
2018/04/04 P. 1
P.O.
> : PV009471
**
õ ** FROM : SHIMADA SHOJI CO.,LTD
PURCHASE ORDER 1-12,3-CHOME ,TANIMACHI,
TO : VIETNAM CHUO-KU,OSAKA,JAPAN
KANEDA TEL.06-6943-1145 FAX.06-6943-7471
------------------------------------------------------------------------------------------------
1312267 CONTRACT
> : 19SS-CRCS-TENV STYLE
> : TOTAL PRICE TERMS : US\
TRANSPORTATION : FOB ORDERER : (13116)ABE.T ASSISTANT : KASAMATSU.M
DESTINATION : HOCHIMINH,VIETNAM REQUESED DELIVERY : 09-APR-18
------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------
| SUPPLIER 7595 SHIMADA SHOJI(VIETNAM) | CASE MARK |
|---------------------------------------------------------------| |
| CONSIGNEE VAT | |
| | |
| BRANCH OF SHIMADA SHOJI(VIETNAM)CO.,LTD. | |
| IN HA NOI | |
| HAREC BLDG., 13FLOOR 4A LANG HA STREET, | |
| BA DINH DISTRICT HA NOI, VIET NAM | |
| TEL:(024)71060181/2 FAX:(024)71060183 | |
| | |
|---------------------------------------------------------------| |
| NOTE 19SS MIZUNO CR-CS
ð«ä ÈäÒæÙ | |
| VIVA GARMENT | |
| | |
| | |
| | |
------------------------------------------------------------------------------------------------
(DETAILS)
------------------------------------------------------------------------------------------------
| COLOR SIZE QUANTITY | UNIT PRICE | AMOUNT |
|-------------------------------------------------------------|-------------|------------------|
| 1)24SVUGV | | |
| (SVUG)POLYESTER & POLYURETHANE ELASTIC WEBBING. | | |
| POLYESTER 83% & POLYURETHANE 17% | | |
| COL.WH SIZE: 20 MM | | |
| 30.00 M |\ 0.1166|\ 3.49 |
| COL.WH SIZE: 25 MM | | |
| 30.00 M |\ 0.1386|\ 4.15 |
| COL.WH SIZE: 40 MM | | |
| 90.00 M |\ 0.2310|\ 20.79 |
|----------------------------------------------------------------------------------------------|
| TOTAL AMOUNT |\ 28.43 |
------------------------------------------------------------------------------------------------
================================================================================================
G.TOTAL
150.00M
================================================================================================
ACCEPTED BY (SELLER) SHIMADA SHOJI CO.,LTD
--------------------------------- ---------------------------------
PLEASE SIGN AND RETURN ONE COPY
2018/04/04 P. 1
P.O.
> : PV009472
**
õ ** FROM : SHIMADA SHOJI CO.,LTD
PURCHASE ORDER 1-12,3-CHOME ,TANIMACHI,
TO : VIETNAM CHUO-KU,OSAKA,JAPAN
KANEDA TEL.06-6943-1145 FAX.06-6943-7471
------------------------------------------------------------------------------------------------
1524014 CONTRACT
> : ATH/FUKURO/0404 PRICE TERMS : US\
TRANSPORTATION : FOB ORDERER : (15204)NAKAJYO.H ASSISTANT : FUKUI.A
DESTINATION : HOCHIMINH,VIETNAM REQUESED DELIVERY : 20-APR-18
------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------
| SUPPLIER 7595 SHIMADA SHOJI(VIETNAM) | CASE MARK |
|---------------------------------------------------------------| |
| CONSIGNEE VNIT | |
| | |
| NIPPON EXPRESS(VIETNAM)CO.,LTD | |
| SONG THAN LOGISTICS CENTER | |
| LOT F, ROAD NO.6, SONG THAN INDUSTRIAL | |
| ZONE II, DI AN DISTRICT, BINH DUONG | |
| PROVINCE, VIETNAM | |
| TEL:84(274)379 4567/FAX:84(274)379 4568 | |
|---------------------------------------------------------------| |
| NOTE
#}¬ | |
| | |
| | |
| | |
| | |
------------------------------------------------------------------------------------------------
(DETAILS)
------------------------------------------------------------------------------------------------
| COLOR SIZE QUANTITY | UNIT PRICE | AMOUNT |
|-------------------------------------------------------------|-------------|------------------|
| 1)19KSK101LN3V | | |
| NO.KSK101LN3V POLYETHYLENE 100% BAG. | | |
| SIZE: 310MM X 370MM | | |
| | | |
| 55,000.00 PCS |\ 0.0550|\ 3,025.00 |
|-------------------------------------------------------------|-------------|------------------|
| 2)19KSK-112LNV | | |
| NO.KSK-112LNV POLYPROPYLENE BAG. | | |
| SIZE: 400MM X 900MM | | |
| | | |
| 7,000.00 PCS |\ 0.0580|\ 406.00 |
|----------------------------------------------------------------------------------------------|
| TOTAL AMOUNT |\ 3,431.00 |
------------------------------------------------------------------------------------------------
================================================================================================
G.TOTAL
62,000 PCS
================================================================================================
ACCEPTED BY (SELLER) SHIMADA SHOJI CO.,LTD
--------------------------------- ---------------------------------
PLEASE SIGN AND RETURN ONE COPY
2018/04/04 P. 1
P.O.
> : PV009473
**
õ ** FROM : SHIMADA SHOJI CO.,LTD
PURCHASE ORDER 1-12,3-CHOME ,TANIMACHI,
TO : VIETNAM CHUO-KU,OSAKA,JAPAN
KANEDA TEL.06-6942-3901 FAX.06-6943-7471
------------------------------------------------------------------------------------------------
1312267 CONTRACT
> : 19SS-CRCS-TENV STYLE
> : TOTAL PRICE TERMS : US\
TRANSPORTATION : FOB ORDERER : (13116)ABE.T ASSISTANT : KASAMATSU.M
DESTINATION : HOCHIMINH,VIETNAM REQUESED DELIVERY : 05-APR-18
------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------
| SUPPLIER 7595 SHIMADA SHOJI(VIETNAM) | CASE MARK |
|---------------------------------------------------------------| |
| CONSIGNEE VAT | |
| | |
| BRANCH OF SHIMADA SHOJI(VIETNAM)CO.,LTD. | |
| IN HA NOI | |
| HAREC BLDG., 13FLOOR 4A LANG HA STREET, | |
| BA DINH DISTRICT HA NOI, VIET NAM | |
| TEL:(024)71060181/2 FAX:(024)71060183 | |
| | |
|---------------------------------------------------------------| |
| NOTE 19SS MIZUNO GMS
ð«ä ÈäÒæÙ | |
| VIVA GARMENT | |
| | |
| | |
| | |
------------------------------------------------------------------------------------------------
(DETAILS)
------------------------------------------------------------------------------------------------
| COLOR SIZE QUANTITY | UNIT PRICE | AMOUNT |
|-------------------------------------------------------------|-------------|------------------|
| 1)66IMS710HBV | | |
| (IMS710HBV)POLYESTER TRICOT FABRIC.(TATEAMI)(DYED) | | |
| WIDTH: 60INCH | | |
| COL.09 | | |
| 25.00 YARDS |\ 0.6050|\ 15.12 |
|----------------------------------------------------------------------------------------------|
| TOTAL AMOUNT |\ 15.12 |
------------------------------------------------------------------------------------------------
================================================================================================
G.TOTAL
25 YARDS
================================================================================================
ACCEPTED BY (SELLER) SHIMADA SHOJI CO.,LTD
--------------------------------- ---------------------------------
PLEASE SIGN AND RETURN ONE COPY
*/

class pv_pdf_model extends CI_Model
{
  const EACH_PV_PATTERN = 
    '/'
    .'(?<pv_content>'
    .'P\.O\.'
    .'[\s\S]+?'
    .'PLEASE SIGN AND RETURN ONE COPY'
    .')'
    .'/';

  const PO_NO_PATTERN = 
    '/'
    .'P\.O\.(\n>)? : ?(?<po_no>.*?)\n'
    .'/';

  const HEADER_PATTERN = 
    '/------------------------------------------------------------------------------------------------\n'
    .'(.*?)( ?CONTRACT ?(\n?>)? : (?<contract_no>.*?))?( ?STYLE ?(\n?>)? : (?<style>.*?)?)?( ?PRICE TERMS : (?<currency>.*?))?\n'
    .'TRANSPORTATION : (.*?) ORDERER : \((?<orderer_id>.*?)\)(?<orderer_name>.*?)( ASSISTANT : (?<assistant>.*?))?\n'
    .'DESTINATION : (.*?) REQUESED DELIVERY : ?(?<delivery_date>.*?)\n'
    .'------------------------------------------------------------------------------------------------\n/';

  const BRANCH_PATTERN = 
    '/'
    .'\|---------------------------------------------------------------\| .*\|\n'
    .'\| CONSIGNEE (?<customer>.*)\| .*\|\n'
    .'\| \| .*\|\n'
    .'\| (?<delivery_to_1>BRANCH OF .*) \| .*\|\n'
    .'\| (?<delivery_to_2>IN .*) \| .*\|\n'
    .'\| (?<delivery_address1>.*) \| .*\|\n'
    .'\| (?<delivery_address2>.*) \| .*\|\n'
    .'\| (?<delivery_address3>.*) \| .*\|\n'
    .'\|( (?<delivery_address4>.*))? \| .*\|\n'
    .'\|---------------------------------------------------------------\| .*\|'
    .'/';

  const CUSTOMER_PATTERN = 
    '/'
    .'\|---------------------------------------------------------------\| .*\|\n'
    .'\| CONSIGNEE (?<customer>[^\|]*)\| [^\|]*\|\n'
    .'\| \| [^\|]*\|\n'
    .'\| (?<delivery_to>[^\|]*) \| [^\|]*\|\n'
    .'\| (?<delivery_address1>[^\|]*) \| [^\|]*\|\n'
    .'\| (?<delivery_address2>[^\|]*) \| [^\|]*\|\n'
    .'\| (?<delivery_address3>[^\|]*) \| [^\|]*\|\n'
    .'\|( (?<delivery_address4>[^\|]*))? \| [^\|]*\|\n'
    .'\|( (?<delivery_address5>[^\|]*))? \| [^\|]*\|\n'
    .'\|---------------------------------------------------------------\| .*\|'
    .'/';

  const TOTAL_AMOUT_PARTTERN = 
    '/'
    .'\|----------------------------------------------------------------------------------------------\|\n'
    .'\| TOTAL AMOUNT \|(?<currency>.*) (?<total_amount>[0-9,\\.]+) \|\n'
    .'------------------------------------------------------------------------------------------------'
    .'/';

  const DETAILS_PARTTERN = 
    '/'
    .'\(DETAILS\)\n'
    .'------------------------------------------------------------------------------------------------\n'
    .'\| COLOR SIZE QUANTITY \| UNIT PRICE \| AMOUNT \|\n'
    .'\|-------------------------------------------------------------\|-------------\|------------------\|\n'
    .'([\s\S]+?)'
    .'------------------------------------------------------------------------------------------------'
    .'/';

  const DETAIL_ITEMS_SEPERATOR = '|-------------------------------------------------------------|-------------|------------------|';

  const DETAIL_ITEM_PARTTERN = 
    '/'
    .'\| (?<no>\d+)\)(?<jp_code>.+) \| \| \|\n'
    .'\| (NO\.(?<item_code_1>.+?) |\((?<item_code_2>.+?)\))?(?<name>.+) \| \| \|\n'
    .'(\|(?<name2> ((?!(COL|SIZE)).)*) \| \| \|\n)?'
    .'(\| (?<name3>ITEM CODE:.+) \| \| \|)?'
    .'(?<group_items>[\s\S]+)'
    .'/';

  const ITEM_GROUP_PARTTERN = 
    '/'
    .'('
    .'\| ITEM CODE:(?<item_code>.+?) \| \| \|\n'
    .')?'
    .'(?<sub_items>[\s\S]+)'
    .'/';

  const SUB_ITEM_PARTTERN = 
    '/'
    .'(\|([\s\S])*?( COL.(?<color>.+?))?( SIZE ?: (?<size>.+?))? \| \| \|\n)?'
    .'(\| \| \| \|\n)?'
    .'\| (?<quantity>[0-9,\\.]+) (?<unit>.*) \|(?<currency1>.*) (?<unit_price>[0-9,\\.]+)\|(?<currency2>.*) (?<amount>[0-9,\\.]+) \|\n'
    .'/';

  const SIZE_PATTERN =
    '/'
    .'(?<size_value>[\d\.]+)( )?(?<size_unit>\w+)'
    .'/';

  const SIZE_COMPOSITION_PATTERN =
    '/'
    .'.*X.*'
    .'/';
  public function __construct(){
    $this->load->model('items_model');
  }

  protected $pvCurrency = "";

  public function currency($in) {
    if ($in == "US\\" || $in == "US¥") {
      return "USD";
    } elseif($in == "\$S\\" || $in == "\$") {
      return "JPY";
    }
    return $in;
  }

  public function number($in){
    return (double)str_replace(',', '', $in);
  }

  public function normalizeDate($in){
    $date = DateTime::createFromFormat('j-M-y', $in);
    if ($date === FALSE) {
      return '';
    }
    return $date->format('Y/m/d');
  }

  public function parse($pdfText, $default) {
    $result = [];
    $no_pv = preg_match_all(self::EACH_PV_PATTERN, $pdfText, $matches, PREG_OFFSET_CAPTURE);
    if ($no_pv){
      for ($i=0; $i < $no_pv; $i++) {
        list($content, $offset) = $matches['pv_content'][$i];
        $odrv = $this->parseEach($content, $default);
        $odrv['CONTENT'] = $content;
        $odrv['OFFSET'] = $offset;
        $odrv['PAGE'] = 1 + substr_count($pdfText, "\f", 0, $offset);
        $result[] = $odrv;
      }
    }
    return $result;
  }

  public function parseEach($pvContent, $default) {
    $currentEmployeeId = $this->session->userdata("user")['employee_id'];
    $default = array_merge(array(
      'kubun' => ORDER_RECEIVED_TYPE_JP,
      'input_user' => $currentEmployeeId,
      'order_receive_date' => date('Y/m/d'),
    ), $default );

    $odr = $default;

    if (preg_match(self::PO_NO_PATTERN, $pvContent, $matches)){
      $odr['order_receive_no'] = $matches['po_no'];
    }

    if (preg_match(self::HEADER_PATTERN, $pvContent, $matches)){
      // print_r($matches);
      $odr['contract_no'] = $matches['contract_no'];
      $odr['style'] = $matches['style'];
      $odr['currency'] = $this->currency($matches['currency']);
      $this->pvCurrency = $odr['currency'];
      $odr['assistance'] = $this->currency($matches['assistant']);
      $odr['staff'] = "({$matches['orderer_id']}){$matches['orderer_name']}";
      $odr['delivery_date'] = $this->normalizeDate($this->currency($matches['delivery_date']));
    }

    if (preg_match(self::BRANCH_PATTERN, $pvContent, $matches)){
      // print_r($matches);
      $odr['customer'] = $matches['customer'];
      $odr['delivery_to'] = $matches['delivery_to_1'] . ' ' . $matches['delivery_to_2'];
      $addresses = [];
      for ($i=1; $i < 5; $i++) { 
        if (!empty($matches["delivery_address$i"])){
          $addresses[] = $matches["delivery_address$i"];
        }
      }
      $odr['delivery_address'] = implode("\n", $addresses);
    } else if (preg_match(self::CUSTOMER_PATTERN, $pvContent, $matches)){
      // print_r($matches);
      $odr['customer'] = $matches['customer'];
      $odr['delivery_to'] = $matches['delivery_to'];
      $addresses = [];
      for ($i=1; $i < 6; $i++) { 
        if (!empty($matches["delivery_address$i"])){
          $addresses[] = $matches["delivery_address$i"];
        }
      }
      $odr['delivery_address'] = implode("\n", $addresses);
    }

    if (preg_match(self::TOTAL_AMOUT_PARTTERN, $pvContent, $matches)){
      // print_r($matches);
      $odr['sum_amount'] = $this->number($matches['total_amount']);
    }

    $odr['details'] = [];
    if (preg_match_all(self::DETAILS_PARTTERN, $pvContent, $matches)){
      $items = explode(self::DETAIL_ITEMS_SEPERATOR, implode('', $matches[1]));
      $total_quantity = 0;
      foreach ($items as $key => $item) {
        if (preg_match(self::DETAIL_ITEM_PARTTERN, $item, $matches)){
          $detail = array();
          // $detail['no'] = $matches['no'];
          $detail['jp_code'] = $matches['jp_code'];
          $detail['item_code'] = $matches['item_code_1'] . $matches['item_code_2'];
          $detail['item_name'] = trim($matches['name']);
          $detail['composition_1'] = $matches['name2'];
          if(!empty($matches['name3'])) {
            $detail['composition_2'] = $matches['name3'];
          } else {
            $detail['composition_2'] = NULL;
          }
          
          $group_items = $matches['group_items'];

          $no_group_items = preg_match_all(self::ITEM_GROUP_PARTTERN, $group_items, $matches);
          if ($no_group_items){
            for ($i=0; $i < $no_group_items; $i++) {
              $group_detail = $detail;
              if (!empty($matches['item_code'][$i])){
                $group_detail['item_code'] = $matches['item_code'][$i];
              }

              $sub_items = $matches['sub_items'][$i];
              $no_sub_items = preg_match_all(self::SUB_ITEM_PARTTERN, $sub_items, $matches);
              if ($no_sub_items){
                for ($j=0; $j < $no_sub_items; $j++) {
                  $sub_detail = $group_detail;
                  $sub_detail['color'] = (!empty($matches['color'][$j])) ? $matches['color'][$j] : "";
                  if(preg_match(self::SIZE_COMPOSITION_PATTERN, $matches['size'][$j], $c_size)){
                    $sub_detail['size'] = '';
                    $sub_detail['size_unit'] = '';
                    if($matches['size'][$j] != '') {
                      $sub_detail['composition_3'] = "SIZE : ".$matches['size'][$j];
                    }
                  }else if (preg_match(self::SIZE_PATTERN, $matches['size'][$j], $m_sizes)) {
                    $sub_detail['size'] = $m_sizes['size_value'];
                    $sub_detail['size_unit'] = $m_sizes['size_unit'];
                  } else {
                    $sub_detail['size'] = '';
                    $sub_detail['size_unit'] = '';
                    if($matches['size'][$j] != '') {
                      $sub_detail['composition_1'] = $matches['size'][$j];
                    }
                  }
                  $sub_detail['quantity'] = $this->number($matches['quantity'][$j]);
                  $total_quantity += $this->number($matches['quantity'][$j]);
                  $sub_detail['unit'] = $matches['unit'][$j];
                  $sub_detail['sell_price'] = NULL;
                  $sub_detail['base_price'] = NULL;
                  $sub_detail['amount'] = NULL;
                  $sub_detail['amount_base'] = NULL;

                  $sub_detail['item_code_flg'] = false;
                  $sub_detail['item_name'] = ($sub_detail['item_code'] == '') ? $sub_detail['item_name'] : '(' . $sub_detail['item_code'] . ')' . $sub_detail['item_name'];
                  $sub_detail['item_code'] = ($sub_detail['item_code'] == '') ? substr($sub_detail['jp_code'], 2, -1) : $sub_detail['item_code'];
                  $odr['details'][] = $sub_detail;
                }
                // check exist item in Item Master
                $itemCheck = $this->items_model->getByItemCodesList($odr['details'], $odr['staff']);
                if($itemCheck != null) {
                  foreach ($odr['details'] as &$it) {
                    $fillFlg = false;
                    foreach ($itemCheck as $itChk) {
                      $itChk['jp_code_pattern'] = isset($itChk['jp_code_pattern']) && $itChk['jp_code_pattern'] !== null && $itChk['jp_code_pattern'] !== "" ? $itChk['jp_code_pattern'] : "-";
                      $it['size'] = $it['size'] == NULL?"":trim($it['size']);
                      $it['color'] = $it['color'] == NULL?"":trim($it['color']);
                      $it['jp_code'] = isset($it['jp_code']) && !empty($it['jp_code'])?$it['jp_code']:"";
                      if(( trim($it['jp_code']) == trim($itChk['jp_code_pattern']))
                      && $it['size'] === trim($itChk['size'])
                      && ($it['color'] == trim($itChk['color'] )|| $it['color'] == trim($itChk['komoku_name_3']))
                      && trim($odr['staff'] != null ? $odr['staff'] : "") === trim($itChk['salesman'])){
                        $it['item_code_flg'] = true;
                        $fillFlg = true;
                        $this->setPrice($this->pvCurrency, $it, $itChk);
                        break;
                      }
                    }
                    if (!$fillFlg) {
                      foreach ($itemCheck as $itChk) {
                        $it['size'] = $it['size'] == NULL?"":trim($it['size']);
                        $it['color'] = $it['color'] == NULL?"":trim($it['color']);
                        $itChk['jp_code_pattern'] = isset($itChk['jp_code_pattern']) && $itChk['jp_code_pattern'] !== null && $itChk['jp_code_pattern'] !== "" ? $itChk['jp_code_pattern'] : "-";
                        if(( trim($it['jp_code']) == trim($itChk['jp_code_pattern']))
                        && $it['size'] === trim($itChk['size'])
                        && ($it['color'] == trim($itChk['color'] )|| $it['color'] == trim($itChk['komoku_name_3']))){
                          $it['item_code_flg'] = true;
                          $fillFlg = true;
                          $this->setPrice($this->pvCurrency, $it, $itChk);
                          break;
                        }
                      }
                    }
                    if (!$fillFlg) {
                      foreach ($itemCheck as $itChk) {
                        $it['size'] = $it['size'] == NULL?"":trim($it['size']);
                        $it['color'] = $it['color'] == NULL?"":trim($it['color']);
                        $itChk['jp_code_pattern'] = isset($itChk['jp_code_pattern']) && $itChk['jp_code_pattern'] !== null && $itChk['jp_code_pattern'] !== "" ? $itChk['jp_code_pattern'] : "-";
                        if(( strpos($it['jp_code'],$itChk['jp_code_pattern']) !== false)
                        && $it['size'] === trim($itChk['size'])
                        && ($it['color'] == trim($itChk['color'] )|| $it['color'] == trim($itChk['komoku_name_3']))){
                          $it['item_code_flg'] = true;
                          $this->setPrice($this->pvCurrency, $it, $itChk);
                          break;
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
        $odr['sum_quantity'] = $total_quantity;
      }
    }
    return $odr;
  }
  function setPrice($currency, &$it, &$itChk) {
    switch($currency) {
      case "VND":
        $it['sell_price'] = (double)$itChk['sell_price_vnd'];
        $it['base_price'] = (double)$itChk['base_price_vnd'];
        $it['amount'] = $it['sell_price'] * $it['quantity'];
        $it['amount_base'] = $it['base_price'] * $it['quantity'];
        break;
      case "JPY":
        $it['sell_price'] = (double)$itChk['sell_price_jpy'];
        $it['base_price'] = (double)$itChk['base_price_jpy'];
        $it['amount'] = $it['sell_price'] * $it['quantity'];
        $it['amount_base'] = $it['base_price'] * $it['quantity'];
        break;
      case "USD":
        $it['sell_price'] = (double)$itChk['sell_price_usd'];
        $it['base_price'] = (double)$itChk['base_price_usd'];
        $it['amount'] = $it['sell_price'] * $it['quantity'];
        $it['amount_base'] = $it['base_price'] * $it['quantity'];
        break;
      default:
        $it['sell_price'] = NULL;
        $it['base_price'] = NULL;
        $it['amount'] = NULL;
        $it['amount_base'] = NULL;
        break;
    }
  }

}