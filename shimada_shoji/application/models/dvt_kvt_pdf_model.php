<?php

/*
15:48:10
TO :VIETNAM 2018/02/08 P. 1
: :SANUKI.S (70106) / MIYAKE.M
===============================================================================================
: VIET TIEN GARMENT CORPORATION.
: VIET TIEN GARMENT
: B/L : : S
===============================================================================================
---------------------------------------------------------------------------------------------
| (0007) VIET TIEN GARMENT CORPORATION. |
| NO.7 LE MINH XUAN STREET,TAN BINH |
| DISTRICT HOCHIMINH CITY,VIETNAM |
| ATTN: LE THI HONG YEN |
| POST CODE: 70500 |
| TEL:084-2838654869 FAX:084-28654867 |
| |
|-------------------------------------------------------------------------------------------|
|
| |
| |
| |
---------------------------------------------------------------------------------------------
(7013030)
------------------------------------------------------------------------------------------------
| | | | |
|----|-----------------|--------------------------------|--------------------------------------|
| 1 | KVT009951 | SH-VTEC-18AW-01 81800032 | |
------------------------------------------------------------------------------------------------
PV008217,8779,8789
?´åë®Ëä´
G5U1
Î~³ ~²¼
#}µä¼(*Ë)
#}µä¼(³·)
3¢ê¨ e­ËÉuÊ Õ(¬Ý
Î~s
Ö-
±yßA> µä> }â
óígwØPO²á
15:48:10
TO :VIETNAM 2018/02/08 P. 1
(DVT008517)
: : SANUKI.S (70106) aÉÊjän : MIYAKE.M
------------------------------------------------------------------------------------------------
7013030 : SH-VTEC-18AW-01 : 81800032
------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------
| | CASE MARK |
| (0007) | |
| VIET TIEN GARMENT CORPORATION. | |
| NO.7 LE MINH XUAN STREET,TAN BINH | VIET TIEN/KURO |
| DISTRICT HOCHIMINH CITY,VIETNAM | |
| ATTN: LE THI HONG YEN | SH-VTEC-18AW-01 |
| POST CODE: 70500 | |
| TEL:084-2838654869 FAX:084-28654867 | S/T NO. 81800032 |
| | O/ NO 30135 |
| | C/NO. 1-UP |
|------------------------------------------------------------|
| |
| | |
| | |
| | |
| | |
| | |
------------------------------------------------------------------------------------------
(DETAILS)
------------------------------------------------------------------------------------------------
| |
|----------------------------------------------------------------------------------------------|
| 1)66VTN888V VTN888V VTN888V tæäÉå° |
| (VTN888V) POLYESTER TAFFETA SLEEK.(DYED) |
| WIDTH: 150 CM |
| COL.2 2560.00 M (J) |
|----------------------------------------------------------------------------------------------|
| 2)67VTN888ST2 VTN888ST2 VTN888-ST-2 |
| (VTN888-ST-2) POLYESTER WAIST BELT. |
| SIZE: 70 MM |
| COL.2 SIZE: 70 MM 6685.00 M (J) |
|----------------------------------------------------------------------------------------------|
| 3)17KTV KTV ivc©°Òå |
| (KTV) NON WOVEN TAPE |
| COL.W SIZE: 9 MM 8600.00 M (J) |
|----------------------------------------------------------------------------------------------|
| 4)61T117DTAVTS T117DTAVTST117DTAV-TS bäÈbnåsåÙn |
| (T117DTA-TS) POLYESTER INSIDE BELT. (FUSED) |
| COL.N SIZE: 38 MM 9600.00 M (J) |
|----------------------------------------------------------------------------------------------|
| 5)71KBS33V KBS-33V KBS-33V |
| (KBS-33) NON WOVEN FABRIC.(FUSED) |
| WIDTH: 100 CM |
| COL.W 654.00 M (J) |
|----------------------------------------------------------------------------------------------|
| 6)71KBS33V-T KBS33V-T KBS-33V f®nm°Òæ |
| (KBS-33-TS) NON WOVEN TAPE.(FUSED) |
| COL.W SIZE: 12 MM 7600.00 M (J) |
|----------------------------------------------------------------------------------------------|
| 7)531465194V 1465194V 3CFCDAKENSIN/1500019 |
| (1500019)(CFC-36 DA E P12 B-E TS-TWM)POLYESTER |
| COIL ZIPPER CLOSED END.(N-ANTI)(KENSIN) |
| COL.580 SIZE: 024CM 7111.00 PCS (J) |
------------------------------------------------------------------------------------------------
?´åë®Ëä´
G5U1
Î~³ ~²¼
µä> }â
Î~s
Ö-
}3 ±yéÞ
uu
VB
2018/02/08 P. 2
(DVT008517)
(DETAILS)
------------------------------------------------------------------------------------------------
| |
|----------------------------------------------------------------------------------------------|
| 8)14T366ALV T-366ALV T-366ALV |
| (T366ALV) HOOK & EYE. 4PCS/SET. |
| (STAINLESS & ALUMINIUM MADE) |
| COL.N 7111.00 SETS (J) |
|----------------------------------------------------------------------------------------------|
| 9)01GO160V GO160V GO 160V |
| (GO160V) UREA BUTTON. |
| COL.09 SIZE: 15 MM 5070.00 PCS (J) |
| .................................................................................. |
| COL.58 SIZE: 15 MM 2041.00 PCS (J) |
|----------------------------------------------------------------------------------------------|
| 10)0188WPV 88WPV Êåtåä |
| (88WP-V) POLYESTER BUTTON. |
| COL.40 SIZE: 14.5MM 7111.00 PCS (J) |
|----------------------------------------------------------------------------------------------|
| 11)67S81560-60V S81560-60V Æåw S81560 60MM |
| (S81560-60V) POLYESTER & POLYURETHANE ELASTIC |
| WEBBING. |
| COL.A1 SIZE: 60 MM 1565.00 M (J) |
|----------------------------------------------------------------------------------------------|
| 12)17AYAV AYAV A m°Òæ |
| (AYAV) SPUN RAYON TAPE. |
| COL.W SIZE: 9 MM 1650.00 M (J) |
|----------------------------------------------------------------------------------------------|
| 13)246CGOPV 6CGOPV 6Æ°Ùesæ]ä |
| (6CGOPV)POLYPROPYLEN & POLYURETHANE ELASTIC BRAID. |
| SIZE: 6CORD |
| COL.W 1350.00 M (J) |
|----------------------------------------------------------------------------------------------|
| 14)24S82509V S82509V S82509V |
| (S82509V) POLYESTER & POLYURETHANE ELASTIC WEBBING |
| COL.A1 SIZE: 25 MM 1351.09 M (J) |
------------------------------------------------------------------------------------------------
===============================================================================================
G.TOTAL( )
41,615.09M 21,333 PCS 7,111 SETS
===============================================================================================
}3 ±yéÞ
Ùfä
¨
¨
uu
ï
ÉDw
±yéÞ
 */

class dvt_kvt_pdf_model extends CI_Model
{
  // DVT patterns
    const EACH_DVT_PATTERN =
        '/'
        . '(?<pv_content>\d+:\d+:\d+\nTO :.*\n(\*+\n.*\*+\n)?(DV[^\s]*)(.*\n)+?(===============================================================================================\n)([\s\S]+?)((óígwØPO²á.*\n|\|.*\|.*\|.*\|.*\|\n------------------------------------------------------------------------------------------------)(.*\n)+?\))'
        . '/';

    const DVT_NO_PATTERN =
        '/'
        . 'TO :.* (?<order_date>[0-9]{4}\/[0-9]{2}\/[0-9]{2}) .*\n(\*+\n.*\*+\n)?(?<dvt_no>DV[^\s]*)(.*\n)+?(Î~³( )?:( )?(?<delivery_require_date>\S+).*\n)~²¼\s?:\s?(?<staff>\S*)( |\.)?\((?<staff_id>.*)\)( \/ (?<assistance>\S*))?\n==============================================================================================='
        . '/';

    const DVT_HEADER_PATTERN =
        '/'
        . '===============================================================================================\n#}µä¼\(\*Ë\)( )?:( )?(?<buyer>.*)\n(.*\n)+?(.*3¢ê¨( )?:(?<delivery_method>.*))\n?(((?<delivery_method1>.*) )?B\/L :.*\n)(.*\n)?===============================================================================================\n'
        . '/';

    const DVT_BRANCH_PATTERN =
        '/'
        . '---------------------------------------------------------------------------------------------\n(\|\n|\| )?((.* \(.*?\) )?(?<factory_address1>[^\|]*)) \|\n\| (?<factory_address2>[^\|]* )?\|\n\| (?<factory_address3>[^\|]* )?\|\n\| (?<factory_address4>[^\|]* )?\|\n\| (?<factory_address5>[^\|]* )?\|\n\| (?<factory_address6>[^\|]* )?\|\n\| (?<factory_address7>[^\|]* )?\|\n\|-------------------------------------------------------------------------------------------\|'
        . '/';

    const DVT_ITEM_CONTENT =
        '/'
        . '\|----\|-----------------\|--------------------------------\|--------------------------------------\|\n'
        . '(?<dvt_content>[\s\S]+?)'
        . '------------------------------------------------------------------------------------------------\n'
        . '/';

    const DVT_ITEM_DETAIL =
        '/'
        . '\|.*\| (?<kvt_no>\S*) \| (?<contract_no>.*?\s)?(?<style_no>\S*\s)?\|.*\|\n'
        . '/';

    const DVT_PV_NO =
        '/'
        . '\|.*\|.*\|.*\|.*\|\n------------------------------------------------------------------------------------------------\n(óígwØPO²á )(?<pv_infor>[\s\S]+)\'
        . '/';

    const DVT_PV_PATTERN =
        '/'
        . '[a-zA-Z]+[0-9]+(-[0-9]+)?'
        . '/';

    const DVT_SPLIT_PV_PATTERN =
        '/'
        . '[\s\/\,]+'
        . '/';

  // KVT patterns
    const EACH_KVT_PATTERN =
        '/'
        . '(?<pv_content>\d+:\d+:\d+\nTO :.*\n(\*+\n.*\*+\n)?KV[^\s](.*\n)+?\(DV.*\)\n(.*\n)+?------------------------------------------------------------------------------------------------\n[\s\S]+?\nG\.TOTAL( )?\((.*\n)+?===============================================================================================)'
        . '/';

    const KVT_NO_PATTERN =
        '/'
        . 'TO :.* (?<order_date>[0-9]{4}\/[0-9]{2}\/[0-9]{2}) .*\n(\*+\n.*\*+\n)?(?<kvt_no>KV[^\s]*)(.*\n)+?\((?<dvt_no>DV.*)\)\n(.*\n)+?(Î~³( )?:( )?(?<delivery_date>.*))\n~²¼( )?:( )?(?<staff>[^\(]*)( |\.)?(\((?<staff_id>\S*)\))?( .*:( )?(?<assistance>\s\S*))?\n------------------------------------------------------------------------------------------------'
        . '/';

    const KVT_BRANCH_PATTERN =
        '/'
        . '(\|\n|\|).*\| CASE MARK \|\n'
        . '\|.*\|.*\|\n'
        . '(?<factory_content>[\s\S]+)\|------------------------------------------------------------\|'
        . '/';

    const KVT_BRANCH_DETAIL_PATTERN =
        '/'
        . '\|.*\| (O\/( )?NO(\.)? (?<o_no>.*)|(S\/N(0|O)\.( )?|S\/T N(0|O)\.( )?)(?<style_no>.*)|((CONTRACT NO\.|CONT NO\.)(?<contract_no>.*))) \|\n'
        . '/';
    const KVT_BRANCH_ADDRESS_PATTERN =
        '/'
        . '\| (?<factory>.*) \|.*\|\n'
        . '\| (?<factory_address1>[^\|]* )?\|.*\|\n'
        . '\| (?<factory_address2>[^\|]* )?\|.*\|\n'
        . '\| (?<factory_address3>[^\|]* )?\|.*\|\n'
        . '\| (?<factory_address4>[^\|]* )?\|.*\|\n'
        . '\| (?<factory_address5>[^\|]* )?\|.*\|\n'
        . '\| (?<factory_address6>[^\|]* )?\|.*\|\n'
        . '\| (?<factory_address7>[^\|]* )?\|.*\|\n'
        . '/';

    const KVT_CASE_MARK_PATTERN =
        '/'
        . '(\|\n|\|).*\| CASE MARK \|\n'
        . '\|.*\| (?<case_mark1>.* )?\|\n'
        . '\|.*\| (?<case_mark2>.* )?\|\n'
        . '\|.*\| (?<case_mark3>.* )?\|\n'
        . '\|.*\| (?<case_mark4>.* )?\|\n'
        . '\|.*\| (?<case_mark5>.* )?\|\n'
        . '\|.*\| (?<case_mark6>.* )?\|\n'
        . '\|.*\| (?<case_mark7>.* )?\|\n'
        . '\|.*\| (?<case_mark8>.* )?\|\n'
        . '\|.*\| (?<case_mark9>.* )?\|\n'
        . '\|------------------------------------------------------------\|\n'
        . '\| (?<case_mark10>.* )?\|\n'
        . '(\|\n|\|).*\| (?<case_mark11>.* )?\|\n'
        . '\|.*\| (?<case_mark12>.* )?\|\n'
        . '\|.*\| (?<case_mark13>.* )?\|\n'
        . '\|.*\| (?<case_mark14>.* )?\|\n'
        . '\|.*\| (?<case_mark15>.* )?\|\n'
        . '/';

    const KVT_STYLE_CONTRACT_PATTERN =
        '/'
        . '-+\n.*\nµä> :(?<contract_no>.*)\n}â : ?(?<style_no>[^\s]*)[\s\S]*-+'
        . '/';

    const KVT_ITEM_CONTENT =
        '/'
        . '\(DETAILS\)\n------------------------------------------------------------------------------------------------\n(.*\n){2}(\|----------------------------------------------------------------------------------------------\|\n)?(?<kvt_content>[\s\S]+?)------------------------------------------------------------------------------------------------\n'
        . '/';

    const BEGIN_KVT_ITEM_PATTERN =
        '/'
        . '^(\| (?<detail_no>\d+)\)(?<jp_code>\S+).*(\|)?)$'
        . '/m';

    const KVT_ITEM_DETAIL =
        '/'
        . '\|----------------------------------------------------------------------------------------------\|\n\| (?<detail_no>\d+)\)(?<jp_code>\S+).*(\||[^\|]+\n.*)\n\| (\((?<item_code>\S+)\))?( )?(?<item_name>.+) \|\n(?<group_items>((?!\|-+\|).*\n)+)'
        . '/';

    const KVT_READ_COLSIZE =
        '/'
        . '(\| (?<item3>.*) \|\n)?\| ((COL.(?<color>\S+\s))?(SIZE: ((?<size>\d+(\.\d+)?)( )?(?<size_unit>\w+)|(?<size_1>\S+)) )?)?(?<quantity>[\d\.\,]+)( )?(?<unit>[a-zA-Z]+)\s([^X][\(\)A-Z]+)?(\s[A-Z-\d]+)? \|'
        . '/';

    const KVT_PAGE_DELIMIT = "|----------------------------------------------------------------------------------------------|\n";

    public function __construct()
    {
        $this->load->model('items_model');
        $this->load->model('order_received_details_model');
    }

    public function parse($pdfText, $default)
    {
        $result['dvt'] = [];
        $result['kvt'] = [];

        $no_dvt = preg_match_all(self::EACH_DVT_PATTERN, $pdfText, $matches, PREG_OFFSET_CAPTURE);
        if ($no_dvt) {
            for ($i = 0; $i < $no_dvt; $i++) {
                list($content, $offset) = $matches['pv_content'][$i];
                $odrv = $this->parseEachDVT($content, $default);
                $result['dvt'][] = $odrv;
            }
        }

        $no_kvt = preg_match_all(self::EACH_KVT_PATTERN, $pdfText, $matches, PREG_OFFSET_CAPTURE);
        if ($no_kvt) {
            $dvt_index = 0;
            $dvt_detail_index = 0;
            for ($i = 0; $i < $no_kvt; $i++) {
                list($content, $offset) = $matches['pv_content'][$i];
                $odrv = $this->parseEachKVT($content, $default, $result);
        // check pv_infor from DVT
                $key = array_search($odrv['dvt_no'], array_column($result['dvt'], "dvt_no"));
                if (isset($result['dvt'][$key]["pv_infor_counter"]) && $result['dvt'][$key]["pv_infor_counter"] == 1) {
                    $odrv['pv_no'] = $result['dvt'][$key]["pv_infor"];

                    foreach ($odrv["details"] as &$val) {
                        $val["pv_no"] = $result['dvt'][$key]["pv_infor"];
            // get sell + base_price from Master
                        $conditions = array(
                            "order_receive_no" => $odrv['pv_no'],
                            "item_code" => $val["item_code"],
              // "customer_code" => $val["customer_code"],
              // "salesman" => $val["salesman"],
                            "size" => $val["size"],
                            "color" => $val["color"],
                        );
                        $itemMasterData = $this->order_received_details_model->getCurrencyByOrderReceiveNo($conditions);
                        if (null !== $itemMasterData) {
                            $val["sell_price"] = $itemMasterData['sell_price'];
                            $val["base_price"] = $itemMasterData['base_price'];
                            $shoshaPrice = $this->items_model->getItem($conditions, $itemMasterData['currency']);
                            if (null !== $shoshaPrice) {
                                $val["shosha_price"] = $shoshaPrice['shosha_price'];
                            }
                        }
                    }
                }

                $dvt_no_temp = $odrv['dvt_no'];
                if (!isset($result['dvt'][$dvt_index]['dvt_no'])) {
                    $result['dvt'][$dvt_index]['dvt_no'] = $dvt_no_temp;
                    $dvt_detail_index = 0;
                }
                if ($result['dvt'][$dvt_index]['dvt_no'] != $dvt_no_temp) {
                    $result['dvt'][++$dvt_index]['dvt_no'] = $dvt_no_temp;
                    $dvt_detail_index = 0;
                }
        // $odrv['style_no'] = (isset($odrv['style_no'])) ? $odrv['style_no'] : $result['dvt'][$dvt_index]['details'][$dvt_detail_index]['style_no'];
        // $odrv['contract_no'] = (isset($odrv['contract_no'])) ? $odrv['contract_no'] : $result['dvt'][$dvt_index]['details'][$dvt_detail_index++]['contract_no'];
                $result['kvt'][] = $odrv;
            }
        }
        return $result;
    }

    public function parseEachDVT($pvContent, $default)
    {
        $currentEmployeeId = $this->session->userdata("user")['employee_id'];
        $default = array_merge(array(
            'kubun' => ORDER_RECEIVED_TYPE_JP,
            'input_user' => $currentEmployeeId,
            'order_receive_date' => date('Y/m/d'),
            'salesman' => $currentEmployeeId,
            'status' => NOT_YET,
        ), $default);

        $odr = $default;

        $odr['kubun'] = '1';
        if (preg_match(self::DVT_NO_PATTERN, $pvContent, $matches)) {
            $odr['order_date'] = $matches['order_date'];
            $odr['dvt_no'] = $matches['dvt_no'];
            $odr['staff'] = $matches['staff'];
            $odr['staff_id'] = trim($matches['staff_id']);
            if (!empty($matches['assistance'])) $odr['assistance'] = $matches['assistance'];
            $odr['delivery_require_date'] = DateTime::createFromFormat('d-M-y', $matches['delivery_require_date'])->format('Y/m/d');
        }

        if (preg_match(self::DVT_HEADER_PATTERN, $pvContent, $matches)) {
            $odr['buyer'] = $matches['buyer'];
            $matches['delivery_method'] = trim($matches['delivery_method']);
            if (!empty($matches['delivery_method'])) {
                if ($matches['delivery_method'] === 'e­ËÉuÊ') {
                    $odr['delivery_method'] = 'お任せします';
                } else {
                    $odr['delivery_method'] = $matches['delivery_method'];
                }
            } else {
                if ($matches['delivery_method1'] === 'e­ËÉuÊ') {
                    $odr['delivery_method'] = 'お任せします';
                } else {
                    $odr['delivery_method'] = $matches['delivery_method'];
                }
            }
        }

        if (preg_match(self::DVT_BRANCH_PATTERN, $pvContent, $matches)) {
            $addresses = [];
            for ($i = 2; $i < 7; $i++) {
                if (!empty($matches["factory_address$i"])) {
                    $addresses[] = trim($matches["factory_address$i"], " ");
                }
            }
            $odr['address'] = implode("\n", $addresses);
            if (!empty($matches["factory_address1"])) $odr['factory'] = $matches["factory_address1"];
        }
        if (preg_match(self::DVT_PV_NO, $pvContent, $matches)) {
            if (!empty($matches['pv_infor'])) {
                $result = $this->readPVInfo($matches['pv_infor']);
                $odr['pv_infor_counter'] = count($result);
                $odr['pv_infor'] = implode(",", $result);
            }
        }

        if (preg_match(self::DVT_ITEM_CONTENT, $pvContent, $matches)) {
            $no_item = preg_match_all(self::DVT_ITEM_DETAIL, $matches['dvt_content'], $matches);
            if ($no_item) {
                for ($i = 0; $i < $no_item; $i++) {
                    $odr['details'][$i]['kvt_no'] = $matches['kvt_no'][$i];
                    $odr['details'][$i]['contract_no'] = trim($matches['contract_no'][$i]);
                    $odr['details'][$i]['style_no'] = isset($matches['style_no'][$i]) ? trim($matches['style_no'][$i]) : "";
                }
            }
        }
        return $odr;
    }

    public function readPVInfo($pv_info)
    {
    // analyze data
        $resultArr = preg_split(self::DVT_SPLIT_PV_PATTERN, $pv_info);
        $result = array();
        foreach ($resultArr as $key => $value) {
            if (preg_match(self::DVT_PV_PATTERN, $value, $matches)) {
                if (strpos($value, "-") !== false) {
          //split PV000X-Y
                    $tmp = explode("-", $value);
                    for ($i = intval(substr($tmp[0], -1)); $i <= intval(substr($tmp[1], -1)); $i++) {
                        $result[] = substr($tmp[0], 0, -1) . $i;
                    }
                } else {
                    if ($value != "") $result[] = $value;
                }
            }
        }
        return $result;
    }

    public function parseEachKVT($pvContent, $default, &$result)
    {
        $currentEmployeeId = $this->session->userdata("user")['employee_id'];
        $default = array_merge(array(
            'kubun' => ORDER_RECEIVED_TYPE_JP,
            'input_user' => $currentEmployeeId,
            'order_receive_date' => date('Y/m/d'),
        ), $default);

        $odr = $default;
        // echo "<pre>";
        //     print_r($pvContent);
        //     echo "</pre>";
        //     exit();
        if (preg_match(self::KVT_STYLE_CONTRACT_PATTERN, $pvContent, $matches)) {
            $odr['style_no'] = trim($matches['style_no']);
            $odr['contract_no'] = trim($matches['contract_no']);
        }

        if (preg_match(self::KVT_NO_PATTERN, $pvContent, $matches)) {
            $odr['order_date'] = $matches['order_date'];
            $odr['kvt_no'] = $matches['kvt_no'];
            $odr['dvt_no'] = $matches['dvt_no'];
            $odr['staff'] = $matches['staff'];
            $odr['staff_id'] = $matches['staff_id'];
            if (!empty($matches['assistance'])) $odr['assistance'] = trim($matches['assistance'], " ");
            $odr['delivery_date'] = $matches['delivery_date'];
        }
        // assign contract no and style no for dvt detail
        foreach ($result["dvt"] as &$dvt) {
            if ($dvt["dvt_no"] === $odr['dvt_no']) {
                foreach ($dvt["details"] as &$detail) {
                    if ($detail["kvt_no"] === $odr['kvt_no']) {
                        $detail["contract_no"] = isset($odr['contract_no']) ? $odr['contract_no'] : "";
                        $detail["style_no"] = isset($odr['style_no']) ? $odr['style_no'] : "";
                        break;
                    }
                }
                break;
            }
        }

        $case_mark = "";
        if (preg_match(self::KVT_CASE_MARK_PATTERN, $pvContent, $matches)) {
            $case_mark_tmp = [];
            for ($i = 1; $i <= 15; $i++) {
                if (!empty($matches["case_mark$i"])) {
                    $case_mark_tmp[] = trim($matches["case_mark$i"], " ");
                }
            }
            $case_mark = implode("\n", $case_mark_tmp);
        }
        if (preg_match(self::KVT_BRANCH_PATTERN, $pvContent, $branch_matches)) {
            $no_kvt_detail = preg_match_all(self::KVT_BRANCH_DETAIL_PATTERN, $branch_matches['factory_content'], $matches);
            if ($no_kvt_detail) {
                for ($kvt_detail_i = 0; $kvt_detail_i < $no_kvt_detail; $kvt_detail_i++) {
                    // if(!empty($matches["style_no"][$kvt_detail_i]) && $matches["style_no"][$kvt_detail_i] != "") $odr['style_no'] = $matches["style_no"][$kvt_detail_i];
                    if (!empty($matches["o_no"][$kvt_detail_i]) && $matches["o_no"][$kvt_detail_i] != "") $odr['o_no'] = $matches["o_no"][$kvt_detail_i];
                    // if(!empty($matches["contract_no"][$kvt_detail_i]) && $matches["contract_no"][$kvt_detail_i] != "") $odr['contract_no'] = $matches["contract_no"][$kvt_detail_i];
                }
            }
            if (preg_match(self::KVT_BRANCH_ADDRESS_PATTERN, $branch_matches['factory_content'], $matches)) {
                $addresses = [];
                for ($i = 1; $i <= 7; $i++) {
                    if (!empty($matches["factory_address$i"])) {
                        $addresses[] = trim($matches["factory_address$i"], " ");
                    }
                }
                $odr['address'] = implode("\n", $addresses);
                $odr['factory'] = $matches["factory"];
            }
        }

        $no_group_item = preg_match_all(self::KVT_ITEM_CONTENT, $pvContent, $matches_group);
        if ($no_group_item) {
            $idx = 0;
            $kvt_content = "";
            for ($k = 0; $k < $no_group_item; $k++) {
                $tmp = strtok($matches_group['kvt_content'][$k], "\n");
                if (preg_match(self::BEGIN_KVT_ITEM_PATTERN, $tmp, $b_matches)) {
                    $kvt_content .= self::KVT_PAGE_DELIMIT . $matches_group['kvt_content'][$k];
                } else {
                    $kvt_content .= $matches_group['kvt_content'][$k];
                }
            }
            $no_item = preg_match_all(self::KVT_ITEM_DETAIL, $kvt_content, $matches);
            if ($no_item) {
                for ($i = 0; $i < $no_item; $i++) {
                    $odr['details'][$idx]['detail_no'] = $matches['detail_no'][$i];
                    $odr['details'][$idx]['jp_code'] = $matches['jp_code'][$i];
                    $odr['details'][$idx]['item_name'] = ($matches['item_code'][$i] == '') ? $matches['item_name'][$i] : '(' . $matches['item_code'][$i] . ') ' . $matches['item_name'][$i];
                    $odr['details'][$idx]['item_code'] = ($matches['item_code'][$i] == '') ? substr($matches['jp_code'][$i], 2, -1) : $matches['item_code'][$i];
                    $odr['details'][$idx]['case_mark'] = $case_mark;
                    $odr['details'][$idx]['item_code_flg'] = false;

                    $no_list_item = preg_match_all(self::KVT_READ_COLSIZE, $matches['group_items'][$i], $group_matches);
                    if ($no_list_item) {
                        $list_item_temp = $odr['details'][$idx];
                        for ($n = 0; $n < $no_list_item; $n++) {
                            $list_item = $list_item_temp;
                            if (!empty($group_matches['item3'][0])) {
                                $list_item['composition_1'] = $group_matches['item3'][0];
                            }
                            $list_item['color'] = $group_matches['color'][$n];
                            if (!empty($group_matches['size'][$n])) {
                                $list_item['size'] = $group_matches['size'][$n];
                                $list_item['size_unit'] = $group_matches['size_unit'][$n];
                            } elseif (!empty($group_matches['size_1'][$n])) {
                                $list_item['size'] = $group_matches['size_1'][$n];
                            }
                            $list_item['quantity'] = $group_matches['quantity'][$n];
                            $list_item['unit'] = $group_matches['unit'][$n];
                            if (!isset($list_item['size'])) {
                                $list_item['size'] = '';
                                $list_item['size_unit'] = '';
                            }
                            $odr['details'][$idx++] = $list_item;
                        }
                    }
                }
                // check exist item in Item Master
                $itemCheck = $this->items_model->getByItemCodesList($odr['details'], $odr['staff']);
                if ($itemCheck != null) {
                    foreach ($odr['details'] as &$it) {
                        $flg = false;
                        foreach ($itemCheck as $itChk) {
                            if (trim($it['item_code']) === trim($itChk['item_code'])
                                && trim($it['color']) === trim($itChk['color'])
                                && trim($it['size']) === trim($itChk['size'])
                                && trim($odr['staff']) === trim($itChk['salesman'])) {
                                $it['item_code_flg'] = true;
                                $flg = true;
                            }
                        }
                        if (!$flg) {
                            foreach ($itemCheck as $itChk) {
                                if (trim($it['item_code']) === trim($itChk['item_code'])
                                    && trim($it['color']) === trim($itChk['color'])
                                    && trim($it['size']) === trim($itChk['size'])) {
                                    $it['item_code_flg'] = true;
                                }
                            }
                        }
                    }
                }
            }
        }
        return $odr;
    }
}